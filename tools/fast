import os
import tqdm
from concurrent.futures import ThreadPoolExecutor
import struct
import yaml
import shutil

# å°†16è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚
def hex_string_to_bytes(hex_string):
    return bytes.fromhex(hex_string)

# å°†10è¿›åˆ¶æ•°å­—è½¬æ¢ä¸º4ä¸ªå­—èŠ‚çš„16è¿›åˆ¶
def decimal_to_4byte_hex(decimal_value):
    return decimal_value.to_bytes(4, byteorder='little')

# å®šä¹‰è¦æŸ¥æ‰¾çš„æ ‡è®°å’Œç›®æ ‡å­—èŠ‚
def get_markers(start_marker_input, end_marker_input, target_marker_decimal):
    start_marker = hex_string_to_bytes(start_marker_input)  # ä¾‹å¦‚ '33f2' -> b'\x33\xf2'
    end_marker = hex_string_to_bytes(end_marker_input)  # ä¾‹å¦‚ '25f2' -> b'\x25\xf2'
    target_marker = decimal_to_4byte_hex(target_marker_decimal)  # 10è¿›åˆ¶è½¬æ¢ä¸ºå­—èŠ‚
    return start_marker, end_marker, target_marker

# åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„å—
def find_blocks_in_file(content, file_path, found_blocks, start_marker, end_marker, target_marker):
    idx_start = 0
    while idx_start < len(content):
        # æŸ¥æ‰¾èµ·å§‹æ ‡è®°
        start_idx = content.find(start_marker, idx_start)
        if start_idx == -1:
            break  # æ²¡æœ‰æ‰¾åˆ°èµ·å§‹æ ‡è®°
        
        # æŸ¥æ‰¾ç»“æŸæ ‡è®°
        end_idx = content.find(end_marker, start_idx + len(start_marker))
        if end_idx == -1:
            break  # æ²¡æœ‰æ‰¾åˆ°ç»“æŸæ ‡è®°
        
        # æ£€æŸ¥èµ·å§‹æ ‡è®°å’Œç»“æŸæ ‡è®°ä¹‹é—´æ˜¯å¦æœ‰14ä¸ªå­—èŠ‚
        if end_idx - (start_idx + len(start_marker)) == 14:
            # ç›®æ ‡å­—èŠ‚æŸ¥æ‰¾ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ªç›®æ ‡å­—èŠ‚
            target_start_idx = end_idx + len(end_marker) + 15  # ä»ç»“æŸæ ‡è®°å15ä¸ªå­—èŠ‚å¼€å§‹
            first_target_value = content[target_start_idx:target_start_idx + 4]
            block_start = target_start_idx + 4  # è®°å½•ç›®æ ‡å­—èŠ‚åçš„ä½ç½®
            
            # æ‰¾åˆ°ç¬¬äºŒä¸ªç›®æ ‡å­—èŠ‚
            second_target_idx = content.find(first_target_value, block_start)
            if second_target_idx != -1:
                # è®°å½•å—çš„ç›®æ ‡å­—èŠ‚å’Œå…¶ä½ç½®
                found_blocks.append({
                    'file': file_path,
                    'first_target_value': first_target_value.hex(),
                    'first_target_position': target_start_idx,
                    'second_target_value': first_target_value.hex(),
                    'second_target_position': second_target_idx
                })
        
        # ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå—
        idx_start = end_idx + len(end_marker)

def find_blocks_in_file_vehicle(content, file_path, found_blocks, start_marker, end_marker, target_marker):
    idx_start = 0

    while idx_start < len(content):
        # æŸ¥æ‰¾èµ·å§‹æ ‡è®°
        start_idx = content.find(start_marker, idx_start)
        if start_idx == -1:
            break  # æ²¡æœ‰æ‰¾åˆ°èµ·å§‹æ ‡è®°
        
        # æŸ¥æ‰¾ç»“æŸæ ‡è®°
        end_idx = content.find(end_marker, start_idx + len(start_marker))
        if end_idx == -1:
            break  # æ²¡æœ‰æ‰¾åˆ°ç»“æŸæ ‡è®°
        
        # æ£€æŸ¥èµ·å§‹æ ‡è®°å’Œç»“æŸæ ‡è®°ä¹‹é—´æ˜¯å¦æœ‰14ä¸ªå­—èŠ‚
        if end_idx - (start_idx + len(start_marker)) == 14:
            # ç›®æ ‡å­—èŠ‚æŸ¥æ‰¾ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ªç›®æ ‡å­—èŠ‚
            target_start_idx = end_idx + len(end_marker) + 15  # ä»ç»“æŸæ ‡è®°å15ä¸ªå­—èŠ‚å¼€å§‹
            first_target_value = content[target_start_idx:target_start_idx + 4]
            block_start = target_start_idx + 4  # è®°å½•ç›®æ ‡å­—èŠ‚åçš„ä½ç½®

            # ğŸš€ è°ƒç”¨ little_endian_append_00 å¤„ç†æ•°æ®
            second_target_value = little_endian_append_00(first_target_value)
            if second_target_value is None:
                #print(f"è·³è¿‡æ— æ•ˆæ•°æ®ï¼Œæ–‡ä»¶: {file_path}, ä½ç½®: {target_start_idx}")
                idx_start = end_idx + len(end_marker)  # ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ª block
                continue  # è·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œé¿å…æŠ¥é”™
            
            # æ‰¾åˆ°ç¬¬äºŒä¸ªç›®æ ‡å­—èŠ‚
            second_target_idx = content.find(second_target_value, block_start)
            if second_target_idx != -1:
                # è®°å½•å—çš„ç›®æ ‡å­—èŠ‚å’Œå…¶ä½ç½®
                found_blocks.append({
                    'file': file_path,
                    'first_target_value': first_target_value.hex(),
                    'first_target_position': target_start_idx,
                    'second_target_value': second_target_value.hex(),
                    'second_target_position': second_target_idx
                })
        
        # ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå—
        idx_start = end_idx + len(end_marker)


def little_endian_append_00(byte_data):
    """
    1. å°†å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®è½¬æ¢ä¸º 10 è¿›åˆ¶æ•´æ•°
    2. åœ¨åé¢æ‹¼æ¥ "00"ï¼ˆç›¸å½“äºä¹˜ 100ï¼Œä½†ä¸ä¼šæº¢å‡ºï¼‰
    3. è½¬æ¢å›å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®ï¼ˆbytesï¼‰
    """
    # 1ï¸âƒ£ ç¡®ä¿æ•°æ®è‡³å°‘ 4 å­—èŠ‚
    if len(byte_data) < 4:
        #print(f"é”™è¯¯ï¼šæ•°æ® {byte_data} é•¿åº¦ä¸è¶³ 4 å­—èŠ‚ï¼Œè·³è¿‡ï¼")
        return None

    # 2ï¸âƒ£ è§£æå°ç«¯ 16 è¿›åˆ¶ä¸ºæ•´æ•°
    decimal_value = struct.unpack('<I', byte_data)[0]

    # 3ï¸âƒ£ å°†æ•´æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨åé¢åŠ  "00"ï¼Œç„¶åè½¬æ¢å›æ•´æ•°
    new_decimal_value = int(str(decimal_value) + "00")  

    # 4ï¸âƒ£ ç¡®ä¿æ–°å€¼ä¸è¶…è¿‡ 4 å­—èŠ‚æœ€å¤§å€¼ï¼ˆ0xFFFFFFFF = 4294967295ï¼‰
    if new_decimal_value > 0xFFFFFFFF:
        #print(f"é”™è¯¯ï¼šè®¡ç®—ç»“æœ {new_decimal_value} è¶…å‡º 4 å­—èŠ‚èŒƒå›´ï¼Œè·³è¿‡ï¼")
        return None

    # 5ï¸âƒ£ è½¬æ¢å›å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®
    new_little_endian_bytes = struct.pack('<I', new_decimal_value)

    return new_little_endian_bytes  # ä¿æŒ bytes ç±»å‹

import struct

def little_endian_remove_00(byte_data):
    """
    1. å°†å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®è½¬æ¢ä¸º 10 è¿›åˆ¶æ•´æ•°
    2. å»æ‰æœ«å°¾çš„ "00"
    3. è½¬æ¢å›å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®ï¼ˆbytesï¼‰
    """
    # 1ï¸âƒ£ ç¡®ä¿æ•°æ®è‡³å°‘ 4 å­—èŠ‚
    if len(byte_data) < 4:
        return None

    # 2ï¸âƒ£ è§£æå°ç«¯ 16 è¿›åˆ¶ä¸ºæ•´æ•°
    decimal_value = struct.unpack('<I', byte_data)[0]

    # 3ï¸âƒ£ å»æ‰æœ«å°¾çš„ "00"
    new_decimal_value = decimal_value // 100  

    # 4ï¸âƒ£ ç¡®ä¿æ–°å€¼ä¸è¶…è¿‡ 4 å­—èŠ‚æœ€å¤§å€¼ï¼ˆ0xFFFFFFFF = 4294967295ï¼‰
    if new_decimal_value > 0xFFFFFFFF:
        return None

    # 5ï¸âƒ£ è½¬æ¢å›å°ç«¯æ¨¡å¼çš„å­—èŠ‚æ•°æ®
    new_little_endian_bytes = struct.pack('<I', new_decimal_value)

    return new_little_endian_bytes


# éå†æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
def process_file(file_path, start_marker, end_marker, target_marker, found_blocks, found_blocks_no_symmetric):
    try:
        # æ‰“å¼€æ–‡ä»¶å¹¶ä»¥äºŒè¿›åˆ¶æ¨¡å¼è¯»å–å…¶å†…å®¹
        with open(file_path, 'rb') as f:
            content = f.read()
            # æŸ¥æ‰¾æ ‡è®°
            find_blocks_in_file(content, file_path, found_blocks, start_marker, end_marker, target_marker)
            find_blocks_in_file_vehicle(content, file_path, found_blocks_no_symmetric, start_marker, end_marker, target_marker)
    except Exception as e:
        print(f"Error reading file {file_path}: {e}")

# éå†æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
def find_hex_blocks_in_folder(folder_path, start_marker, end_marker, target_marker):
    # å­˜å‚¨æ‰¾åˆ°çš„å—
    found_blocks = []
    found_blocks_no_symmetric = []
    
    # éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½¿ç”¨ tqdm æ˜¾ç¤ºè¿›åº¦æ¡
    files = []
    for root, dirs, files_in_dir in os.walk(folder_path):
        files.extend([os.path.join(root, file) for file in files_in_dir])

    with ThreadPoolExecutor() as executor:
        # ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œå¤„ç†æ–‡ä»¶
        list(tqdm.tqdm(executor.map(lambda file: process_file(file, start_marker, end_marker, target_marker, found_blocks, found_blocks_no_symmetric), files), desc="Processing files", unit="file"))
        
    return found_blocks, found_blocks_no_symmetric

def int_to_hex_little_endian(n):
    # ä½¿ç”¨ struct.pack å°†æ•´æ•°æŒ‰å°ç«¯æ¨¡å¼è½¬æ¢ä¸ºå­—èŠ‚
    byte_data = struct.pack('<I', n)  # '<'è¡¨ç¤ºå°ç«¯æ¨¡å¼ï¼Œ'I'è¡¨ç¤ºæ— ç¬¦å·æ•´æ•°
    # å°†å­—èŠ‚æ•°æ®è½¬æ¢ä¸º16è¿›åˆ¶æ ¼å¼
    hex_data = byte_data.hex()
    return hex_data

def readyaml(file_path):
    # è§£æ YAML æ–‡ä»¶
    with open(file_path, 'r', encoding='utf-8') as file:
        data = yaml.safe_load(file)

    # æå– swap_pairs
    swap_pairs = data.get('swap_pairs', [])

    # æå– hex_markers
    hex_markers = data.get('hex_markers', {})

    # æå– start å’Œ end æ ‡è®°
    start_marker = hex_markers.get('start', '')
    end_marker = hex_markers.get('end', '')
    return swap_pairs, start_marker, end_marker

def swap_hex_values_in_file(file1, pos1, pos2, file2, pos3, pos4, value1, value2):
    """
    åœ¨ file1 å’Œ file2 çš„æŒ‡å®šä½ç½®äº¤æ¢ value1 å’Œ value2ï¼Œå¹¶å¤åˆ¶ä¿®æ”¹åçš„æ–‡ä»¶åˆ° 'äº¤æ¢è¿‡/uexp' ç›®å½•
    """

    global modified_files
    # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
    if not os.path.exists(file1) or not os.path.exists(file2):
        print(f"é”™è¯¯: æ–‡ä»¶ {file1} æˆ– {file2} ä¸å­˜åœ¨ï¼")
        return
    
    # è¯»å– file1
    with open(file1, 'rb') as f:
        content1 = bytearray(f.read())  # è¯»å–æ–‡ä»¶å†…å®¹ä¸ºå¯ä¿®æ”¹çš„å­—èŠ‚æ•°ç»„
    
    # è¯»å– file2
    with open(file2, 'rb') as f:
        content2 = bytearray(f.read())

    # è§£æ 16 è¿›åˆ¶å€¼ä¸ºå­—èŠ‚æ ¼å¼
    bytes_value1 = bytes.fromhex(value1)
    bytes_value2 = bytes.fromhex(value2)

    # äº¤æ¢å†…å®¹
    modified = False
    if file1 == file2:
        if content1[pos1:pos1+len(bytes_value1)] == bytes_value1 and content1[pos2:pos2+len(bytes_value1)] == bytes_value1:
            content1[pos1:pos1+len(bytes_value1)] = bytes_value2
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content1[pos3:pos3+len(bytes_value2)] == bytes_value2 and content1[pos4:pos4+len(bytes_value2)] == bytes_value2:
            content1[pos3:pos3+len(bytes_value2)] = bytes_value1
            content1[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True
    else:
        if content1[pos1:pos1+len(bytes_value1)] == bytes_value1 and content1[pos2:pos2+len(bytes_value1)] == bytes_value1:
            content1[pos1:pos1+len(bytes_value1)] = bytes_value2
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content2[pos3:pos3+len(bytes_value2)] == bytes_value2 and content2[pos4:pos4+len(bytes_value2)] == bytes_value2:
            content2[pos3:pos3+len(bytes_value2)] = bytes_value1
            content2[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True        

    # å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå†™å›æ–‡ä»¶
    if modified:
        if file1 == file2:
            with open(file1, 'wb') as f:
                f.write(content1)
        else:
            with open(file1, 'wb') as f:
                f.write(content1)
            with open(file2, 'wb') as f:
                f.write(content2)

        # # å¤åˆ¶æ–‡ä»¶åˆ° "äº¤æ¢è¿‡/uexp" ç›®å½•
        # shutil.copy2(file1, os.path.join(output_folder, os.path.basename(file1)))
        # shutil.copy2(file2, os.path.join(output_folder, os.path.basename(file2)))
        # è®°å½•å·²ä¿®æ”¹çš„æ–‡ä»¶
        modified_files.add(file1)
        modified_files.add(file2)


        #print(f"æˆåŠŸäº¤æ¢ {file1} å’Œ {file2} çš„æ•°æ®ï¼Œå¹¶å·²å¤åˆ¶åˆ° {output_folder}")
def swap_hex_values_in_file_vehicle(file1, pos1, pos2, file2, pos3, pos4, value1, value2):
    """
    åœ¨ file1 å’Œ file2 çš„æŒ‡å®šä½ç½®äº¤æ¢ value1 å’Œ value2ï¼Œå¹¶å¤åˆ¶ä¿®æ”¹åçš„æ–‡ä»¶åˆ° 'äº¤æ¢è¿‡/uexp' ç›®å½•
    """
    global modified_files
    # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
    if not os.path.exists(file1) or not os.path.exists(file2):
        print(f"é”™è¯¯: æ–‡ä»¶ {file1} æˆ– {file2} ä¸å­˜åœ¨ï¼")
        return
    
    # è¯»å– file1
    with open(file1, 'rb') as f:
        content1 = bytearray(f.read())  # è¯»å–æ–‡ä»¶å†…å®¹ä¸ºå¯ä¿®æ”¹çš„å­—èŠ‚æ•°ç»„
    
    # è¯»å– file2
    with open(file2, 'rb') as f:
        content2 = bytearray(f.read())

    # è§£æ 16 è¿›åˆ¶å€¼ä¸ºå­—èŠ‚æ ¼å¼
    bytes_value1 = bytes.fromhex(value1)
    bytes_value2 = bytes.fromhex(value2)

    # äº¤æ¢å†…å®¹
    modified = False
    if file1 == file2:
        if content1[pos2:pos2+len(bytes_value1)] == bytes_value1:

            #content1[pos1:pos1+len(bytes_value1)] = little_endian_remove_00(bytes_value2)
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content1[pos4:pos4+len(bytes_value2)] == bytes_value2:
            #content2[pos3:pos3+len(bytes_value2)] = little_endian_remove_00(bytes_value1)
            content1[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True
    else:
        if content1[pos2:pos2+len(bytes_value1)] == bytes_value1:

            #content1[pos1:pos1+len(bytes_value1)] = little_endian_remove_00(bytes_value2)
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content2[pos4:pos4+len(bytes_value2)] == bytes_value2:
            #content2[pos3:pos3+len(bytes_value2)] = little_endian_remove_00(bytes_value1)
            content2[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True

    # å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå†™å›æ–‡ä»¶
    if modified:
        if file1 == file2:
                # print(content1[pos2:pos2+len(bytes_value1)], bytes_value1)
            with open(file1, 'wb') as f:
                f.write(content1)

        else:
            # print(content1[pos2:pos2+len(bytes_value1)], bytes_value1)
            with open(file1, 'wb') as f:
                f.write(content1)
            with open(file2, 'wb') as f:
                f.write(content2)

        # # å¤åˆ¶æ–‡ä»¶åˆ° "äº¤æ¢è¿‡/uexp" ç›®å½•
        # shutil.copy2(file1, os.path.join(output_folder, os.path.basename(file1)))
        # shutil.copy2(file2, os.path.join(output_folder, os.path.basename(file2)))

        # print(f"æˆåŠŸäº¤æ¢ {file1} å’Œ {file2} çš„æ•°æ®ï¼Œå¹¶å·²å¤åˆ¶åˆ° {output_folder}")
        modified_files.add(file1)
        modified_files.add(file2)


def swap_hex_values_in_file_weapon(file1, pos1, pos2, file2, pos3, pos4, value1, value2):

    """
    åœ¨ file1 å’Œ file2 çš„æŒ‡å®šä½ç½®äº¤æ¢ value1 å’Œ value2ï¼Œå¹¶å¤åˆ¶ä¿®æ”¹åçš„æ–‡ä»¶åˆ° 'äº¤æ¢è¿‡/uexp' ç›®å½•
    """
    global modified_files
    #ç¡®ä¿æ–‡ä»¶å­˜åœ¨
    if not os.path.exists(file1) or not os.path.exists(file2):
        print(f"é”™è¯¯: æ–‡ä»¶ {file1} æˆ– {file2} ä¸å­˜åœ¨ï¼")
        return
    
    # è¯»å– file1
    with open(file1, 'rb') as f:
        content1 = bytearray(f.read())  # è¯»å–æ–‡ä»¶å†…å®¹ä¸ºå¯ä¿®æ”¹çš„å­—èŠ‚æ•°ç»„
    
    # è¯»å– file2
    with open(file2, 'rb') as f:
        content2 = bytearray(f.read())

    # è§£æ 16 è¿›åˆ¶å€¼ä¸ºå­—èŠ‚æ ¼å¼
    bytes_value1 = bytes.fromhex(value1)
    bytes_value2 = bytes.fromhex(value2)

    # äº¤æ¢å†…å®¹
    modified = False
    if file1 == file2:

        if content1[pos2:pos2+len(bytes_value1)] == bytes_value1:
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content1[pos3:pos3+len(bytes_value2)] == bytes_value2 and content1[pos4:pos4+len(bytes_value2)] == bytes_value2:
            content1[pos3:pos3+len(bytes_value2)] = bytes_value1
            content1[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True
    else:
        if content1[pos2:pos2+len(bytes_value1)] == bytes_value1:
            content1[pos2:pos2+len(bytes_value1)] = bytes_value2
            modified = True

        if content2[pos3:pos3+len(bytes_value2)] == bytes_value2 and content2[pos4:pos4+len(bytes_value2)] == bytes_value2:
            content2[pos3:pos3+len(bytes_value2)] = bytes_value1
            content2[pos4:pos4+len(bytes_value2)] = bytes_value1
            modified = True
    # å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå†™å›æ–‡ä»¶
    if modified:
        if file1 == file2:
            with open(file1, 'wb') as f:
                f.write(content1)
        else:
            with open(file1, 'wb') as f:
                f.write(content1)
            with open(file2, 'wb') as f:
                f.write(content2)            
        # # å¤åˆ¶æ–‡ä»¶åˆ° "äº¤æ¢è¿‡/uexp" ç›®å½•
        # shutil.copy2(file1, os.path.join(output_folder, os.path.basename(file1)))
        # shutil.copy2(file2, os.path.join(output_folder, os.path.basename(file2)))

        # print(f"æˆåŠŸäº¤æ¢ {file1} å’Œ {file2} çš„æ•°æ®ï¼Œå¹¶å·²å¤åˆ¶åˆ° {output_folder}")
        modified_files.add(file1)
        modified_files.add(file2)

def copy_modified_files(output_folder):
    # ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
    os.makedirs(output_folder, exist_ok=True)

    for file in modified_files:
        shutil.copy2(file, os.path.join(output_folder, os.path.basename(file)))
        print(f"å·²å¤åˆ¶ä¿®æ”¹è¿‡çš„æ–‡ä»¶: {file} åˆ° {output_folder}")


def delete_unmodified_files(directory, modified_files):
    for file_name in os.listdir(directory):
        file_path = os.path.join(directory, file_name)
        if file_path not in modified_files and os.path.isfile(file_path):
            os.remove(file_path)
            # print(f"å·²åˆ é™¤æœªä¿®æ”¹çš„æ–‡ä»¶: {file_path}")
    print('ç¾åŒ–å®Œæˆï¼Œæ¥ä¸‹æ¥è¯·ä½¿ç”¨ï¼Œuexpæ‰“åŒ…')

def copy_uexp_files(source_folder, destination_folder):
    """
    æ¸…ç©ºç›®æ ‡æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æºæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ã€‚

    Args:
        source_folder (str): æºæ–‡ä»¶å¤¹è·¯å¾„ã€‚
        destination_folder (str): ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ã€‚
    """
    try:
        # æ¸…ç©ºç›®æ ‡æ–‡ä»¶å¤¹
        if os.path.exists(destination_folder):
            shutil.rmtree(destination_folder)
        os.makedirs(destination_folder)

        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
        for filename in os.listdir(source_folder):
            source_path = os.path.join(source_folder, filename)
            destination_path = os.path.join(destination_folder, filename)
            if os.path.isfile(source_path):#åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶ï¼Œå¦‚æœæ˜¯æ–‡ä»¶ï¼Œåˆ™è¿›è¡Œå¤åˆ¶
                shutil.copy2(source_path, destination_path)
            elif os.path.isdir(source_path):#åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œåˆ™é€’å½’è°ƒç”¨è‡ªèº«
                shutil.copytree(source_path, destination_path)

        # print("æ–‡ä»¶å¤åˆ¶å®Œæˆã€‚")

    except Exception as e:
        print(f"å‘ç”Ÿé”™è¯¯ï¼š{e}")


copy_uexp_files('è§£åŒ…æ•°æ®/uexp', 'æ‰“åŒ…/uexp')
# ç¤ºä¾‹è¾“å…¥
start_marker_input = ''  # è¾“å…¥çš„16è¿›åˆ¶æ ‡è®°
end_marker_input = ''  # è¾“å…¥çš„16è¿›åˆ¶æ ‡è®°
target_marker_decimal = 403211  # è¾“å…¥çš„10è¿›åˆ¶æ•°å­—

file_path = 'å¿«é€Ÿç¾åŒ–.yaml'
file_path_vehicle = 'è½½å…·é…ç½®.yaml'
file_path_weapon = 'æªæ¢°é…ç½®.yaml'
first_block = []
last_block = []

cloth_to_swap, start_marker_input, end_marker_input = readyaml(file_path)
vehicle_to_swap, _, _ = readyaml(file_path_vehicle)
weapon_to_swap, _, _ = readyaml(file_path_weapon)
modified_files = set()
# è·å–æ‰€æœ‰æ ‡è®°
start_marker, end_marker, target_marker = get_markers(start_marker_input, end_marker_input, target_marker_decimal)

# è¿è¡Œç¨‹åºå¹¶æ˜¾ç¤ºæ‰¾åˆ°çš„å—

source_folder_path = 'è§£åŒ…æ•°æ®/uexp'
folder_path = 'æ‰“åŒ…/uexp'  # è®¾ç½®æ–‡ä»¶å¤¹è·¯å¾„
found_blocks, found_blocks_no_symmetric = find_hex_blocks_in_folder(folder_path, start_marker, end_marker, target_marker)
# print(len(found_blocks_no_symmetric))

# ç›®æ ‡æ–‡ä»¶å¤¹
output_folder = 'æ‰“åŒ…/uexp'
os.makedirs(output_folder, exist_ok=True)



#è¡£æœ
# é¢„å¤„ç† found_blocksï¼Œåˆ›å»ºå­—å…¸ç´¢å¼•ï¼ŒåŠ é€ŸæŸ¥æ‰¾
found_blocks_dict = {block['first_target_value']: block for block in found_blocks}
found_blocks_no_symmetric_dict = {block['second_target_value']: block for block in found_blocks_no_symmetric}
# print(len(found_blocks_no_symmetric_dict))

cloth_to_swap_temp = []
for pair in cloth_to_swap:
    first_hex = int_to_hex_little_endian(pair[0])
    last_hex = int_to_hex_little_endian(pair[1])

    first_block = found_blocks_dict.get(first_hex)  # O(1) æŸ¥æ‰¾
    last_block = found_blocks_dict.get(last_hex)    # O(1) æŸ¥æ‰¾

    if first_block and last_block:  # ç¡®ä¿éƒ½æ‰¾åˆ°äº†
        cloth_to_swap_temp.append([first_block, last_block])

# æ‰¹é‡æ‰§è¡Œæ–‡ä»¶äº¤æ¢ï¼Œå‡å°‘ I/O å¼€é”€
for first_block, last_block in cloth_to_swap_temp:
    swap_hex_values_in_file(
        first_block['file'], first_block['first_target_position'], first_block['second_target_position'],
        last_block['file'], last_block['first_target_position'], last_block['second_target_position'],
        first_block['first_target_value'], last_block['first_target_value']
    )


#è½½å…·
vehicle_to_swap_temp = []
for pair in vehicle_to_swap:
    first_hex = int_to_hex_little_endian(pair[0])
    last_hex = int_to_hex_little_endian(pair[1])

    first_block = found_blocks_no_symmetric_dict.get(first_hex)  # O(1) æŸ¥æ‰¾
    last_block = found_blocks_no_symmetric_dict.get(last_hex)    # O(1) æŸ¥æ‰¾

    if first_block and last_block:  # ç¡®ä¿éƒ½æ‰¾åˆ°äº†
        vehicle_to_swap_temp.append([first_block, last_block])
#print(vehicle_to_swap_temp)
# æ‰¹é‡æ‰§è¡Œæ–‡ä»¶äº¤æ¢ï¼Œå‡å°‘ I/O å¼€é”€
for first_block, last_block in vehicle_to_swap_temp:
    swap_hex_values_in_file_vehicle(
        first_block['file'], first_block['first_target_position'], first_block['second_target_position'],
        last_block['file'], last_block['first_target_position'], last_block['second_target_position'],
        first_block['second_target_value'], last_block['second_target_value']
    )


#æ­¦å™¨
weapon_to_swap_temp = []
for pair in weapon_to_swap:
    first_hex = int_to_hex_little_endian(pair[0])
    last_hex = int_to_hex_little_endian(pair[1])

    first_block = found_blocks_no_symmetric_dict.get(first_hex)  # O(1) æŸ¥æ‰¾
    last_block = found_blocks_dict.get(last_hex)    # O(1) æŸ¥æ‰¾

    if first_block and last_block:  # ç¡®ä¿éƒ½æ‰¾åˆ°äº†

        weapon_to_swap_temp.append([first_block, last_block])

# æ‰¹é‡æ‰§è¡Œæ–‡ä»¶äº¤æ¢ï¼Œå‡å°‘ I/O å¼€é”€
for first_block, last_block in weapon_to_swap_temp:
    swap_hex_values_in_file_weapon(
        first_block['file'], first_block['first_target_position'], first_block['second_target_position'],
        last_block['file'], last_block['first_target_position'], last_block['second_target_position'],
        first_block['second_target_value'], last_block['first_target_value']
    )


# copy_modified_files(output_folder)
delete_unmodified_files(output_folder, modified_files)
